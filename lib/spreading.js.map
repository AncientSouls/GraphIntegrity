{"version":3,"sources":["../src/lib/spreading.js"],"names":["GraphSpreading","spreadGraph","pathGraphs","pathGraph","push","pathLink","context","handler","callback","fetch","_variableField","_fromField","undefined","error","spreadLinks","length","queue","spreadLink","spreadFromSpreadLinkByPathLink","id","newSpreadLink","_spreadingHandler","insert","spreadFromSpreadLinkByPathGraph","drain","pathLinks","_constantField","_toField","root","spreadLinkId","prev","next","remove","count","pathLinkId","path"],"mappings":"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","file":"spreading.js","sourcesContent":["import async from 'async';\n\n/**\n * Class with methods for spread and unspread of the spreadGraph on pathGraph(s).\n * \n * @class\n * @description `import { GraphSpreading } from 'ancient-graph-spreading';`\n */\nclass GraphSpreading {\n  \n  /**\n   * @param {SpreadGraph} spreadGraph\n   */\n  constructor(spreadGraph) {\n    this.spreadGraph = spreadGraph;\n    this.pathGraphs = [];\n  }\n  \n  /**\n   * @param {PathGraph} pathGraph\n   */\n  addPathGraph(pathGraph) {\n    this.pathGraphs.push(pathGraph);\n  }\n  \n  /**\n   * Spread by pathLink with available spreadLinks.\n   * \n   * @param {PathGraph} pathGraph\n   * @param {PathLink} pathLink\n   * @param {Object} [context]\n   * @param {GraphSpreading~spreadFromSpreadLinkByPathLinkCallback} [handler]\n   * @param {GraphSpreading~spreadByPathLinkCallback} [callback]\n   */\n  spreadByPathLink(pathGraph, pathLink, context, handler, callback) {\n    this.spreadGraph.fetch({\n      [this.spreadGraph._variableField]: pathLink[pathGraph._fromField]\n    }, undefined, (error, spreadLinks) => {\n      if (spreadLinks.length) {\n        var queue = async.queue((spreadLink, callback) => {\n          this.spreadFromSpreadLinkByPathLink(spreadLink, pathGraph, pathLink, context, (error, id, spreadLink, pathGraph, pathLink) => {\n            if (handler) handler(error, id, spreadLink, pathGraph, pathLink);\n            callback();\n          });\n        });\n        queue.push(spreadLinks, (error) => {\n          if (callback) callback();\n        });\n      } else {\n        if (callback) callback();\n      }\n    });\n  }\n  \n  /**\n   * Optional callback.\n   *\n   * @callback GraphSpreading~spreadByPathLinkCallback\n   */\n  \n  /**\n   * Spread root of tree spreadLink.\n   * \n   * @param {SpreadLink} newSpreadLink\n   * @param {Object} [context]\n   * @param {Graph~insertCallback} [callback]\n   */\n  spreadNewSpreadLink(newSpreadLink, context, callback) {\n    this.spreadGraph._spreadingHandler(undefined, undefined, undefined, newSpreadLink, context, (newSpreadLink) => {\n      if (newSpreadLink) this.spreadGraph.insert(newSpreadLink, callback, context);\n    });\n  }\n  \n  /**\n   * Spread by all available paths from spreadLink.\n   * \n   * @param {SpreadLink} spreadLink\n   * @param {Object} [context]\n   * @param {GraphSpreading~spreadFromSpreadLinkByPathGraphHandler} [handler]\n   * @param {GraphSpreading~spreadFromSpreadLinkByPathGraphCallback} [callback]\n   */\n  spreadFromSpreadLink(spreadLink, context, handler, callback) {\n    var queue = async.queue((pathGraph, callback) => {\n      this.spreadFromSpreadLinkByPathGraph(spreadLink, pathGraph, context, handler, callback);\n    });\n    queue.drain = () => { if (callback) callback(); }\n    queue.push(this.pathGraphs);\n  }\n  \n  /**\n   * Spread by all available paths in pathGraph from spreadLink.\n   * \n   * @param {SpreadLink} spreadLink\n   * @param {PathGraph} pathGraph\n   * @param {GraphSpreading~spreadFromSpreadLinkByPathGraphHandler} [handler]\n   * @param {GraphSpreading~spreadFromSpreadLinkByPathGraphCallback} [callback]\n   */\n  spreadFromSpreadLinkByPathGraph(spreadLink, pathGraph, context, handler, callback) {\n    pathGraph.fetch({\n      [pathGraph._fromField]: spreadLink[this.spreadGraph._variableField]\n    }, undefined, (error, pathLinks) => {\n      var queue = async.queue((pathLink, callback) => {\n        this.spreadFromSpreadLinkByPathLink(spreadLink, pathGraph, pathLink, context, (error, id) => {\n          if (handler) handler(error, id, spreadLink, pathGraph, pathLink);\n          callback();\n        });\n      });\n      queue.drain = () => { if (callback) callback(); }\n      queue.push(pathLinks);\n    });\n  }\n  \n  /**\n   * Optional handler. If present, called with an error object as the first argument and, if no error, others arguments with results of spreading.\n   *\n   * @callback GraphSpreading~spreadFromSpreadLinkByPathGraphHandler\n   * @param {Error} [error]\n   * @param {string} [id]\n   * @param {SpreadLink} [spreadLink]\n   * @param {PathGraph} [pathGraph]\n   * @param {PathLink} [pathLink]\n   */\n  \n  /**\n   * Optional callback.\n   *\n   * @callback GraphSpreading~spreadFromSpreadLinkByPathGraphCallback\n   */\n  \n  /**\n   * Spread by pathLink in pathGraph from spreadLink.\n   * \n   * @param {SpreadLink} spreadLink\n   * @param {PathGraph} pathGraph\n   * @param {PathLink} pathLink\n   * @param {Object} [context]\n   * @param {GraphSpreading~spreadFromSpreadLinkByPathLinkCallback} [callback]\n   */\n  spreadFromSpreadLinkByPathLink(spreadLink, pathGraph, pathLink, context, callback) {\n    this.spreadGraph._spreadingHandler(spreadLink, pathGraph, pathLink, {\n      [this.spreadGraph._constantField]: spreadLink[this.spreadGraph._constantField],\n      [this.spreadGraph._variableField]: pathLink[pathGraph._toField],\n      prev: spreadLink.id,\n      path: pathLink.id,\n      root: spreadLink.root?spreadLink.root:spreadLink.id\n    }, context, (newSpreadLink) => {\n      if (newSpreadLink) this.spreadGraph.insert(newSpreadLink, (error, id) => {\n        if (callback) callback(error, id, spreadLink, pathGraph, pathLink);\n      }, context);\n    });\n  }\n  \n  /**\n   * Optional callback. If present, called with an error object as the first argument and, if no error, the unique id of inserted spread link as the second.\n   *\n   * @callback GraphSpreading~spreadFromSpreadLinkByPathLinkCallback\n   * @param {Error} [error]\n   * @param {string} [id]\n   * @param {SpreadLink} [spreadLink]\n   * @param {PathGraph} [pathGraph]\n   * @param {PathLink} [pathLink]\n   */\n  \n  /**\n   * Remove spreadLinks with specific prev spreadLink id.\n   * \n   * @param {string} spreadLinkId\n   * @param {Object} [context]\n   * @param {GraphSpreading~unspreadFromRemovedSpreadLinkByPrevIdHandler} [handler]\n   * @param {GraphSpreading~unspreadFromRemovedSpreadLinkByPrevIdCallback} [callback]\n   */\n  unspreadFromRemovedSpreadLinkByPrevId(spreadLinkId, context, handler, callback) {\n    if (handler) {\n      this.spreadGraph.fetch({ prev: spreadLinkId }, undefined, (error, spreadLinks) => {\n        if (error) {\n          if (callback) callback(error);\n        } else {\n          var queue = async.queue((spreadLink, next) => {\n            this.spreadGraph.remove(spreadLink.id, (error, count) => {\n              handler(error, spreadLink);\n              next();\n            }, context);\n          });\n          if (callback) queue.drain = () => { callback(undefined, spreadLinks.length); }\n          queue.push(spreadLinks);\n        }\n      });\n    } else {\n      this.spreadGraph.remove({ prev: spreadLinkId }, callback, context);\n    }\n  }\n  \n  /**\n   * Optional handler. If present, called with an error object as the first argument and, if no error, others arguments with results of unspreading.\n   *\n   * @callback GraphSpreading~unspreadFromRemovedSpreadLinkByPrevIdHandler\n   * @param {Error} [error]\n   * @param {SpreadLink} [spreadLink]\n   */\n  \n  /**\n   * Optional callback.\n   *\n   * @callback GraphSpreading~unspreadFromRemovedSpreadLinkByPrevIdCallback\n   * @param {Error} [error]\n   * @param {number} [count]\n   */\n  \n  /**\n   * Remove spreadLinks with specific path pathLink id.\n   * \n   * @param {string} pathLinkId\n   * @param {Object} [context]\n   * @param {GraphSpreading~unspreadByPathIdHandler} [handler]\n   * @param {GraphSpreading~unspreadByPathIdCallback} [callback]\n   */\n  unspreadByPathId(pathLinkId, context, handler, callback) {\n    if (handler) {\n      this.spreadGraph.fetch({ path: pathLinkId }, undefined, (error, spreadLinks) => {\n        if (error) {\n          if (callback) callback(error);\n        } else {\n          var queue = async.queue((spreadLink, next) => {\n            this.spreadGraph.remove(spreadLink.id, (error, count) => {\n              handler(error, spreadLink);\n              next();\n            }, context);\n          });\n          if (callback) queue.drain = () => { callback(undefined, spreadLinks.length); }\n          queue.push(spreadLinks);\n        }\n      });\n    } else {\n      this.spreadGraph.remove({ path: pathLinkId }, callback, context);\n    }\n  }\n  \n  /**\n   * Optional handler. If present, called with an error object as the first argument and, if no error, others arguments with results of unspreading.\n   *\n   * @callback GraphSpreading~unspreadByPathIdHandler\n   * @param {Error} [error]\n   * @param {SpreadLink} [spreadLink]\n   */\n  \n  /**\n   * Optional callback.\n   *\n   * @callback GraphSpreading~unspreadByPathIdCallback\n   * @param {Error} [error]\n   * @param {number} [count]\n   */\n}\n\nexport { GraphSpreading };"]}