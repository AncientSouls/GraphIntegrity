{"version":3,"sources":["../src/tests/testQueue.js"],"names":["testQueue","generageGraphSpreading","ids","it","done","pathGraph","spreadGraph","graphSpreading","queueSpreading","insert","source","target","error","spreadLinkId0","pathLinkId0","on","oldLink","newLink","spreadBySpread","unspreadBySpread","spreadByPath","lengthOf","launched","fetch","undefined","results","deepEqual","id","prev","path","root","process","mainPathLink","unspreadByPath","isEqual","pathLinkId1","update","removed","setTimeout","spreadLinks","pathLinks","remove"],"mappings":"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","file":"testQueue.js","sourcesContent":["import { assert } from 'chai';\nimport { factoryPathGraph, factorySpreadGraph, GraphSpreading, QueueSpreading } from '../';\nimport lodash from 'lodash';\n\nexport default function testQueue(generageGraphSpreading, ids) {\n  it('#spreadByPath', function(done) {\n    var { pathGraph, spreadGraph, graphSpreading, queueSpreading } = generageGraphSpreading();\n    \n    spreadGraph.insert({ source: ids[0], target: ids[1] }, (error, spreadLinkId0) => {\n      pathGraph.insert({ source: ids[2], target: ids[3] }, (error, pathLinkId0) => {\n        spreadGraph.on('insert', (oldLink, newLink) => {\n          queueSpreading.spreadBySpread(newLink);\n        });\n        spreadGraph.on('remove', (oldLink, newLink) => {\n          queueSpreading.unspreadBySpread(oldLink);\n        });\n        pathGraph.on('insert', (oldLink, newLink) => {\n          queueSpreading.spreadByPath(pathGraph, newLink);\n        });\n        pathGraph.on('update', (oldLink, newLink) => {\n          assert.lengthOf(newLink.launched, 0);\n          spreadGraph.fetch({}, undefined, (error, results) => {\n            assert.deepEqual(results, [\n              { source: 'a', target: 'b', id: 'spread/0' },\n              {\n                source: 'a', target: 'c', id: 'spread/1',\n                prev: 'spread/0', path: 'path/1', root: 'spread/0',\n                process: [],\n              },\n              {\n                source: 'a', target: 'd', id: 'spread/2',\n                prev: 'spread/1', path: 'path/0', root: 'spread/0',\n                process: [],\n              }\n            ]);\n            done();\n          });\n        });\n        pathGraph.insert({ source: ids[1], target: ids[2] });\n      });\n    });\n  });\n  it('#unspreadByPath #spreadByPath', function(done) {\n    var { pathGraph, spreadGraph, graphSpreading, queueSpreading } = generageGraphSpreading();\n    \n    var mainPathLink;\n    \n    spreadGraph.on('insert', (oldLink, newLink) => {\n      queueSpreading.spreadBySpread(newLink);\n    });\n    spreadGraph.on('remove', (oldLink, newLink) => {\n      queueSpreading.unspreadBySpread(oldLink);\n    });\n    pathGraph.on('insert', (oldLink, newLink) => {\n      queueSpreading.spreadByPath(pathGraph, newLink);\n    });\n    pathGraph.on('update', (oldLink, newLink) => {\n      if (oldLink.source != newLink.source || oldLink.target != newLink.target) {\n        queueSpreading.unspreadByPath(pathGraph, newLink);\n      } else if(!lodash.isEqual(oldLink.launched, newLink.launched)) {\n        if (newLink.id == mainPathLink && newLink.launched == 0) {\n          spreadGraph.fetch({}, undefined, (error, results) => {\n            assert.deepEqual(results, [\n              { source: 'a', target: 'b', id: 'spread/0' },\n              {\n                source: 'a', target: 'c', id: 'spread/1',\n                prev: 'spread/0', path: 'path/0', root: 'spread/0',\n                process: [],\n              },\n              {\n                source: 'a', target: 'd', id: 'spread/2',\n                prev: 'spread/1', path: 'path/1', root: 'spread/0',\n                process: [],\n              }\n            ]);\n            pathGraph.fetch({}, undefined, (error, results) => {\n              assert.deepEqual(results, [\n                {\n                  \"id\": \"path/0\",\n                  \"launched\": [],\n                  \"source\": \"b\",\n                  \"target\": \"c\"\n                },\n                {\n                  \"id\": \"path/1\",\n                  \"launched\": [],\n                  \"source\": \"c\",\n                  \"target\": \"d\"\n                }\n              ]);\n              done();\n            });\n          });\n        } else {\n          queueSpreading.spreadByPath(pathGraph, newLink);\n        }\n      }\n    });\n    \n    spreadGraph.insert({ source: ids[0], target: ids[1] }, (error, spreadLinkId0) => {\n      pathGraph.insert({ source: ids[3], target: ids[3] }, (error, pathLinkId0) => {\n        mainPathLink = pathLinkId0;\n        pathGraph.insert({ source: ids[2], target: ids[3] }, (error, pathLinkId1) => {\n          pathGraph.update(pathLinkId0, { source: ids[1], target: ids[2] });\n        });\n      });\n    });\n  });\n  \n  it('#unspreadByPath', function(done) {\n    var { pathGraph, spreadGraph, graphSpreading, queueSpreading } = generageGraphSpreading();\n    \n    var mainPathLink;\n    \n    spreadGraph.on('insert', (oldLink, newLink) => {\n      queueSpreading.spreadBySpread(newLink);\n    });\n    spreadGraph.on('remove', (oldLink, newLink) => {\n      queueSpreading.unspreadBySpread(oldLink);\n    });\n    pathGraph.on('insert', (oldLink, newLink) => {\n      queueSpreading.spreadByPath(pathGraph, newLink);\n    });\n    pathGraph.on('update', (oldLink, newLink) => {\n      if (oldLink.source != newLink.source || oldLink.target != newLink.target) {\n        queueSpreading.unspreadByPath(pathGraph, newLink);\n      } else if(!lodash.isEqual(oldLink.launched, newLink.launched)) {\n        queueSpreading.spreadByPath(pathGraph, newLink);\n      }\n    });\n    pathGraph.on('remove', (oldLink, newLink) => {\n      queueSpreading.unspreadByPath(pathGraph, oldLink);\n    });\n    pathGraph.removed.on('update', (oldLink, newLink) => {\n      setTimeout(() => {\n        spreadGraph.fetch({}, undefined, (error, spreadLinks) => {\n          assert.deepEqual(spreadLinks, [\n            { id: 'spread/0', source: 'a', target: 'b' }\n          ]);\n          pathGraph.fetch({}, undefined, (error, pathLinks) => {\n            assert.deepEqual(pathLinks, [\n              { id: 'path/1', source: 'c', target: 'd', launched: [] }\n            ]);\n            done();\n          });\n        });\n      }, 200);\n    });\n    \n    spreadGraph.insert({ source: ids[0], target: ids[1] }, (error, spreadLinkId0) => {\n      pathGraph.insert({ source: ids[1], target: ids[2] }, (error, pathLinkId0) => {\n        pathGraph.insert({ source: ids[2], target: ids[3] }, (error, pathLinkId1) => {\n          pathGraph.remove(pathLinkId0);\n        });\n      });\n    });\n  });\n};"]}